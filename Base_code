import requests
from bs4 import BeautifulSoup

BASE_URL = 'https://books.toscrape.com/'

def get_soup(url):
    res = requests.get(url)
    return BeautifulSoup(res.text, 'html.parser')

def get_categories():
    soup = get_soup(BASE_URL)
    category_section = soup.find('div', class_='side_categories')
    links = category_section.find_all('a')[1:]
    categories = {i+1: (link.text.strip(), BASE_URL + link['href']) for i, link in enumerate(links)}
    return categories

def rating_to_number(star_text):
    ratings = {
        'One': 1,
        'Two': 2,
        'Three': 3,
        'Four': 4,
        'Five': 5
    }
    return ratings.get(star_text, 0)

def search_by_category():
    categories = get_categories()
    print("\nPieejamās kategorijas:")
    for i, (name, _) in categories.items():
        print(f"{i}. {name}")
    try:
        selected = int(input("\nIzvēlieties kategorijas numuru: ").strip())
        name, url = categories.get(selected, (None, None))
        if not name:
            print("Nederīgs numurs.")
            return
        print(f"\nGrāmatas kategorijā '{name}':")
        soup = get_soup(url)
        books = soup.find_all('article', class_='product_pod')
        for book in books:
            title = book.h3.a['title']
            print(f" - {title}")
    except ValueError:
        print("Ievadiet ciparu.")

def search_by_rating():
    try:
        target_rating = int(input("Ievadiet reitingu (1-5): ").strip())
        if target_rating not in range(1, 6):
            raise ValueError
    except ValueError:
        print("Ievadiet skaitli no 1 līdz 5.")
        return

    print(f"\nGrāmatas ar {target_rating} zvaigznēm:")
    url = BASE_URL + 'catalogue/page-1.html'
    soup = get_soup(url)
    books = soup.find_all('article', class_='product_pod')
    for book in books:
        rating_class = book.p['class'][1]
        rating = rating_to_number(rating_class)
        if rating == target_rating:
            title = book.h3.a['title']
            print(f" - {title}")

def search_by_price():
    try:
        min_price = float(input("Min cena: ").strip())
        max_price = float(input("Max cena: ").strip())
    except ValueError:
        print("Nederīga cena.")
        return

    print(f"\nGrāmatas cenā starp £{min_price} un £{max_price}:")
    url = BASE_URL + 'catalogue/page-1.html'
    soup = get_soup(url)
    books = soup.find_all('article', class_='product_pod')
    for book in books:
        price_tag = book.find('p', class_='price_color')
        price_text = price_tag.text.strip().replace('£', '').replace('Â', '').replace('\xa0', '')
        try:
            price = float(price_text)
        except ValueError:
            continue
        if min_price <= price <= max_price:
            title = book.h3.a['title']
            print(f" - {title} (£{price})")

import concurrent.futures

def search_by_name():
    search_term = input("Ievadiet grāmatas nosaukumu (vai daļu no tā): ").strip().lower()
    max_pages = 50  # Books.toscrape has 50 pages
    found_books = []

    def fetch_and_search(page):
        url = BASE_URL + f'catalogue/page-{page}.html'
        try:
            res = requests.get(url, timeout=5)
            if res.status_code != 200:
                return []

            soup = BeautifulSoup(res.text, 'html.parser')
            books = soup.find_all('article', class_='product_pod')
            matches = []
            for book in books:
                title = book.h3.a['title']
                if search_term in title.lower():
                    matches.append(title)
            return matches
        except requests.RequestException:
            return []

    with concurrent.futures.ThreadPoolExecutor() as executor:
        futures = [executor.submit(fetch_and_search, page) for page in range(1, max_pages + 1)]
        for future in concurrent.futures.as_completed(futures):
            found_books.extend(future.result())

    if found_books:
        print("\nAtrastas grāmatas:")
        for title in found_books:
            print(f" - {title}")
    else:
        print("Netika atrasta neviena grāmata ar šādu nosaukumu.")

def main():
    while True:
        print("\nMetodes:")
        print("1. Kategorija")
        print("2. Reitings")
        print("3. Cena")
        print("4. Atrast")
        print("5. Beigt darbu")
        choice = input("Izvēlieties darbību (1-5): ").strip()

        if choice == '1':
            search_by_category()
        elif choice == '2':
            search_by_rating()
        elif choice == '3':
            search_by_price()
        elif choice == '4':
            search_by_name()
        elif choice == '5':
            print("Darbs pārtraukts.")
            break
        else:
            print("Nederīga izvēle.")

if _name_ == "_main_":
    main()